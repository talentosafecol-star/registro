┌─────────────────────────────────────────────────────────────────────────────┐
│                    FLUJO DE AUTENTICACIÓN - SISTEMA DE REPORTE                │
└─────────────────────────────────────────────────────────────────────────────┘

                              REGISTRO DE USUARIO
                    ╔═══════════════════════════════════╗
                    ║     Usuario completa formulario     ║
                    ║   (nombre, email, teléfono, pass)   ║
                    ╚═══════════════════════════════════╝
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   Validación de datos         │
                    │  • Nombre: 2+ caracteres       │
                    │  • Email: formato válido      │
                    │  • Teléfono: 10-15 dígitos    │
                    │  • Password: 8+ may/min/num   │
                    └───────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │   Inválido    │               │    Válido     │
            │  Mostrar error│               │   Continuar    │
            └───────────────┘               └───────────────┘
                                                    │
                                                    ▼
                    ┌───────────────────────────────────────────┐
                    │   Enviar datos al servidor                │
                    │   POST /api/auth/register                  │
                    └───────────────────────────────────────────┘
                                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │   Error       │               │   Éxito       │
            │  Mostrar msg  │               │  Crear usuario│
            └───────────────┘               │  Enviar email │
                                           │  de verificación
                                           └───────────────┘
                                                    │
                                                    ▼
                                           ╔═══════════════════════════╗
                                           ║  Usuario verificado        ║
                                           ║  Redirigir a login        ║
                                           ╚═══════════════════════════╝


                              LOGIN CON OTP
                    ╔═══════════════════════════════════╗
                    ║     Usuario ingresa credenciales   ║
                    ║      (email + contraseña)          ║
                    ╚═══════════════════════════════════╝
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   Validar credenciales        │
                    │   (verificar en DB)          │
                    └───────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │   Inválido    │               │    Válido     │
            │  Mostrar error│               │  Generar OTP  │
            └───────────────┘               │  (6 dígitos)  │
                                            └───────────────┘
                                                    │
                                                    ▼
                    ┌───────────────────────────────────────────┐
                    │   Enviar OTP por email                  │
                    │   Almacenar sessionToken                 │
                    └───────────────────────────────────────────┘
                                                    │
                                                    ▼
                    ╔═══════════════════════════════════╗
                    ║    Usuario ingresa código OTP     ║
                    ║       (6 dígitos - 120s)          ║
                    ╚═══════════════════════════════════╝
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   Verificar código OTP        │
                    │   (comparar con sessionToken) │
                    └───────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │  Inválido/     │               │    Válido     │
            │  Expirado      │               │  Generar JWT   │
            │  Mostrar error│               │  + Refresh    │
            └───────────────┘               └───────────────┘
                                                    │
                                                    ▼
                    ┌───────────────────────────────────────────┐
                    │   Almacenar tokens                        │
                    │   • JWT: sessionStorage                   │
                    │   • Refresh: localStorage                │
                    └───────────────────────────────────────────┘
                                                    │
                                                    ▼
                                           ╔═══════════════════════════╗
                                           ║  Acceso concedido        ║
                                           ║  → Dashboard / Perfil    ║
                                           ╚═══════════════════════════╝


                              GESTIÓN DE PERFIL
                    ╔═══════════════════════════════════╗
                    ║     Verificar token JWT          ║
                    ╚═══════════════════════════════════╝
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   Cargar datos del usuario     │
                    │   desde la base de datos       │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌─────────────────────────────────────┐
                    │   Mostrar información editable      │
                    │   • Nombre                          │
                    │   • Teléfono                        │
                    │   • Preferencias de notificaciones │
                    │   • Historial de seguridad         │
                    └─────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │    Editar     │               │   Cerrar       │
            │   Guardar     │               │   Sesión      │
            │  → Validar    │               │  → Limpiar     │
            │  → Actualizar │               │    tokens      │
            └───────────────┘               └───────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENTES (SRP)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐          │
│  │  RegisterForm   │    │    LoginOTP     │    │  UserProfile   │          │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤          │
│  │  • Registro      │    │  • Credenciales │    │  • Ver perfil   │          │
│  │  • Validación    │    │  • OTP          │    │  • Editar       │          │
│  │  • Feedback      │    │  • Verificación │    │  • Notificaciones│          │
│  └─────────────────┘    └─────────────────┘    │  • Seguridad    │          │
│                                                 └─────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                         ARQUITECTURA (OCP/DIP)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                        AuthService                              │     │
│    │  ┌─────────────────────────────────────────────────────────┐  │     │
│    │  │  setProvider()     → IAuthProvider                       │  │     │
│    │  │  setTokenStorage() → ITokenStorage                        │  │     │
│    │  │  setNotificationService() → INotificationService          │  │     │
│    │  │  setSecurityLogger() → ISecurityLogger                   │  │     │
│    │  └─────────────────────────────────────────────────────────┘  │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    │                                        │
│           ┌────────────────────────┼────────────────────────┐              │
│           │                        │                        │              │
│           ▼                        ▼                        ▼              │
│    ┌─────────────┐         ┌─────────────┐         ┌─────────────┐        │
│    │ IAuthProvider│         │ITokenStorage│         │INotification│        │
│    │              │         │             │         │  Service    │        │
│    │ • login()   │         │ • setToken  │         │ • sendOTP() │        │
│    │ • register()│         │ • getToken   │         │ • sendEmail │        │
│    │ • verifyOTP │         │ • removeToken│         │ • sendAlert │        │
│    └─────────────┘         └─────────────┘         └─────────────┘        │
│           │                                                   │              │
│           ▼                                                   ▼              │
│    ┌─────────────┐                                 ┌─────────────┐        │
│    │ DefaultAuth │                                 │   Email     │        │
│    │  Provider   │                                 │  Service    │        │
│    └─────────────┘                                 └─────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
